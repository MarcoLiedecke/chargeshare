{% extends "base.html" %}

{% block title %}Dashboard - ChargeShare{% endblock %}

{% block additional_styles %}
    .dashboard-container {
        margin-top: 2rem;
    }
    
    .sidebar {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        position: sticky;
        top: 2rem;
    }
    
    .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .sidebar-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .sidebar-link:hover {
        background-color: var(--cs-grey-light);
    }
    
    .sidebar-link.active {
        background-color: var(--cs-green-light);
        color: var(--cs-green-dark);
        font-weight: 500;
    }
    
    .sidebar-link svg {
        margin-right: 0.75rem;
        width: 20px;
        height: 20px;
    }
    
    .dashboard-card {
        height: 100%;
    }
    
    .stat-card {
        border-radius: 10px;
        padding: 1.5rem;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card.chargers {
        background-color: var(--cs-green-light);
        color: var(--cs-green-dark);
    }
    
    .stat-card.reservations {
        background-color: var(--cs-green);
        color: white;
    }
    
    .stat-card.earnings {
        background-color: var(--cs-green-dark);
        color: white;
    }
    
    .stat-card .stat-icon {
        position: absolute;
        right: -15px;
        bottom: -15px;
        opacity: 0.15;
        font-size: 5rem;
    }
    
    .map-container {
        height: 400px;
        width: 100%;
        background-color: var(--cs-grey-light);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .table-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .badge {
        padding: 0.5rem 0.75rem;
        border-radius: 50px;
    }
    
    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .section-title svg {
        margin-right: 0.75rem;
        width: 24px;
        height: 24px;
    }
    
    #addChargerModal .modal-header {
        background-color: var(--cs-green);
        color: white;
    }
{% endblock %}

{% block nav_items %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('index') }}">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2.5L2 8.5V17.5H7V11.5H13V17.5H18V8.5L10 2.5Z" fill="currentColor"/>
        </svg>
        Home
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{{ url_for('dashboard') }}">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3H9V9H3V3ZM11 3H17V9H11V3ZM3 11H9V17H3V11ZM11 11H17V17H11V11Z" fill="currentColor"/>
        </svg>
        Dashboard
    </a>
</li>
{% endblock %}

{% block nav_right %}
<div class="d-flex align-items-center">
    <div class="me-3 text-muted d-none d-md-block">Welcome, {{ current_user.name }}</div>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-primary">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 19H3C2.46957 19 1.96086 18.7893 1.58579 18.4142C1.21071 18.0391 1 17.5304 1 17V3C1 2.46957 1.21071 1.96086 1.58579 1.58579C1.96086 1.21071 2.46957 1 3 1H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 15L19 10L14 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Sign out
    </a>
</div>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <div class="row g-4">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="sidebar">
                    <div class="sidebar-nav">
                        <a href="#dashboard" class="sidebar-link active">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3H9V9H3V3ZM11 3H17V9H11V3ZM3 11H9V17H3V11ZM11 11H17V17H11V11Z" fill="currentColor"/>
                            </svg>
                            Dashboard
                        </a>
                        <a href="#my-chargers" class="sidebar-link">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11 3V11H6.5V17H5V11H3V3H11ZM13 3H17V17H13V3ZM15 5V15H15.2V5H15Z" fill="currentColor"/>
                            </svg>
                            My Chargers
                        </a>
                        <a href="#my-reservations" class="sidebar-link">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 2H17C17.5304 2 18.0391 2.21071 18.4142 2.58579C18.7893 2.96086 19 3.46957 19 4V18C19 18.5304 18.7893 19.0391 18.4142 19.4142C18.0391 19.7893 17.5304 20 17 20H3C2.46957 20 1.96086 19.7893 1.58579 19.4142C1.21071 19.0391 1 18.5304 1 18V4C1 3.46957 1.21071 2.96086 1.58579 2.58579C1.96086 2.21071 2.46957 2 3 2H5V0H7V2H13V0H15V2ZM3 8V18H17V8H3ZM5 10H15V12H5V10ZM5 14H11V16H5V14Z" fill="currentColor"/>
                            </svg>
                            My Reservations
                        </a>
                        <a href="#find-chargers" class="sidebar-link">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 2C5.79086 2 4 3.79086 4 6C4 8.20914 5.79086 10 8 10C10.2091 10 12 8.20914 12 6C12 3.79086 10.2091 2 8 2ZM2 6C2 2.68629 4.68629 0 8 0C11.3137 0 14 2.68629 14 6C14 9.31371 11.3137 12 8 12C4.68629 12 2 9.31371 2 6ZM15.8 14.8C15.5 14.5 15 14.5 14.7 14.8L12.7 16.8C12.4 17.1 12.4 17.5 12.7 17.8C13 18.1 13.4 18.1 13.7 17.8L15.8 15.8C16.1 15.5 16.1 15.1 15.8 14.8Z" fill="currentColor"/>
                            </svg>
                            Find Chargers
                        </a>
                        <a href="#earnings" class="sidebar-link">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM10 18C5.58 18 2 14.42 2 10C2 5.58 5.58 2 10 2C14.42 2 18 5.58 18 10C18 14.42 14.42 18 10 18ZM11 5H9V11H15V9H11V5Z" fill="currentColor"/>
                            </svg>
                            Earnings
                        </a>
                        <a href="#profile" class="sidebar-link">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM10 3C11.66 3 13 4.34 13 6C13 7.66 11.66 9 10 9C8.34 9 7 7.66 7 6C7 4.34 8.34 3 10 3ZM10 17.2C7.5 17.2 5.29 15.92 4 13.98C4.03 11.99 8 10.9 10 10.9C11.99 10.9 15.97 11.99 16 13.98C14.71 15.92 12.5 17.2 10 17.2Z" fill="currentColor"/>
                            </svg>
                            Profile
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <div id="dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="m-0">Dashboard</h1>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addChargerModal">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                                <path d="M8 0C3.58 0 0 3.58 0 8C0 12.42 3.58 16 8 16C12.42 16 16 12.42 16 8C16 3.58 12.42 0 8 0ZM12 9H9V12H7V9H4V7H7V4H9V7H12V9Z" fill="white"/>
                            </svg>
                            Add Charger
                        </button>
                    </div>
                    
                    <!-- Overview Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="stat-card chargers">
                                <h5>My Chargers</h5>
                                <p class="display-4 fw-bold">{{ chargers|length }}</p>
                                <p>Active charging stations</p>
                                <div class="stat-icon">
                                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M44 12V44H26V68H20V44H12V12H44ZM52 12H68V68H52V12ZM60 20V60H60.8V20H60Z" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card reservations">
                                <h5>My Reservations</h5>
                                <p class="display-4 fw-bold">{{ reservations|length }}</p>
                                <p>Active and upcoming reservations</p>
                                <div class="stat-icon">
                                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M60 8H68C69.0609 8 70.0783 8.42143 70.8284 9.17157C71.5786 9.92172 72 10.9391 72 12V68C72 69.0609 71.5786 70.0783 70.8284 70.8284C70.0783 71.5786 69.0609 72 68 72H12C10.9391 72 9.92172 71.5786 9.17157 70.8284C8.42143 70.0783 8 69.0609 8 68V12C8 10.9391 8.42143 9.92172 9.17157 9.17157C9.92172 8.42143 10.9391 8 12 8H20V4H28V8H52V4H60V8ZM12 28V68H68V28H12ZM20 36H60V44H20V36ZM20 52H44V60H20V52Z" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card earnings">
                                <h5>Total Earnings</h5>
                                <p class="display-4 fw-bold">kr {{ '%0.2f'|format(total_earnings|default(0)) }}</p>
                                <p>Earnings from your chargers</p>
                                <div class="stat-icon">
                                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M39.9999 0C19.9199 0 3.99988 15.92 3.99988 36C3.99988 56.08 19.9199 72 39.9999 72C60.0799 72 75.9999 56.08 75.9999 36C75.9999 15.92 60.0799 0 39.9999 0ZM39.9999 64.8C23.9199 64.8 11.1999 52.08 11.1999 36C11.1999 19.92 23.9199 7.2 39.9999 7.2C56.0799 7.2 68.7999 19.92 68.7999 36C68.7999 52.08 56.0799 64.8 39.9999 64.8ZM43.9999 18H35.9999V39.6H57.5999V31.6H43.9999V18Z" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Find Chargers Map Section -->
                <div id="find-chargers" class="mb-5">
                    <div class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="var(--cs-green)"/>
                        </svg>
                        <h2 class="m-0">Find Nearby Chargers</h2>
                    </div>
                    <div class="map-container">
                        <div class="text-center">
                            <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M30 5C19.5 5 11 13.5 11 24C11 39 30 55 30 55C30 55 49 39 49 24C49 13.5 40.5 5 30 5ZM30 31C26.1 31 23 27.9 23 24C23 20.1 26.1 17 30 17C33.9 17 37 20.1 37 24C37 27.9 33.9 31 30 31Z" fill="var(--cs-green-light)"/>
                            </svg>
                            <p>Interactive map will be displayed here</p>
                            <p class="text-muted">This is a placeholder for the actual map integration</p>
                        </div>
                    </div>
                </div>

                <!-- My Chargers Section -->
                <div id="my-chargers" class="mb-5">
                    <div class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.2 4V13.2H7.8V20.4H6V13.2H3.6V4H13.2ZM15.6 4H20.4V20.4H15.6V4ZM18 6V18H18.24V6H18Z" fill="var(--cs-green)"/>
                        </svg>
                        <h2 class="m-0">My Chargers</h2>
                    </div>
                    
                    {% if chargers %}
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Address</th>
                                        <th>Type</th>
                                        <th>Power</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for charger in chargers %}
                                    <tr>
                                        <td>{{ charger.name }}</td>
                                        <td>{{ charger.address }}</td>
                                        <td>{{ charger.charger_type }}</td>
                                        <td>{{ charger.power_output }} kW</td>
                                        <td>kr {{ '%0.2f'|format(charger.price_per_hour) }}/hr</td>
                                        <td>
                                            {% if charger.is_active %}
                                            <span class="badge bg-success">Active</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger">Disable</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <p>You haven't added any chargers yet. <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addChargerModal">Add your first charger</button></p>
                    </div>
                    {% endif %}
                </div>

                <!-- My Reservations Section -->
                <div id="my-reservations" class="mb-5">
                    <div class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 2.5H19.5C19.8978 2.5 20.2794 2.65804 20.5607 2.93934C20.842 3.22064 21 3.60218 21 4V19.5C21 19.8978 20.842 20.2794 20.5607 20.5607C20.2794 20.842 19.8978 21 19.5 21H4.5C4.10218 21 3.72064 20.842 3.43934 20.5607C3.15804 20.2794 3 19.8978 3 19.5V4C3 3.60218 3.15804 3.22064 3.43934 2.93934C3.72064 2.65804 4.10218 2.5 4.5 2.5H6V1H7.5V2.5H16.5V1H18V2.5ZM4.5 8.5V19.5H19.5V8.5H4.5ZM6 11H16.5V12.5H6V11ZM6 15H12V16.5H6V15Z" fill="var(--cs-green)"/>
                        </svg>
                        <h2 class="m-0">My Reservations</h2>
                    </div>
                    
                    {% if reservations %}
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Charger</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Total Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in reservations %}
                                    <tr>
                                        <td>{{ reservation.charger.name }}</td>
                                        <td>{{ reservation.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ reservation.end_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ '%0.1f'|format(reservation.get_duration_hours()) }} hours</td>
                                        <td>kr {{ '%0.2f'|format(reservation.total_price) }}</td>
                                        <td>
                                            {% if reservation.status == 'confirmed' %}
                                            <span class="badge bg-primary">Confirmed</span>
                                            {% elif reservation.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                            {% elif reservation.status == 'pending' %}
                                            <span class="badge" style="background-color: var(--cs-green-light); color: var(--cs-green-dark);">Pending</span>
                                            {% elif reservation.status == 'cancelled' %}
                                            <span class="badge bg-danger">Cancelled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if reservation.status == 'confirmed' %}
                                            <form action="{{ url_for('complete_reservation', reservation_id=reservation.id) }}" method="POST" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-success">Complete</button>
                                            </form>
                                            {% elif reservation.status == 'completed' %}
                                            <button class="btn btn-sm btn-outline-secondary">Rate</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <p>You don't have any active reservations. <a href="#find-chargers" class="alert-link" style="color: var(--cs-green);">Find a charger</a> to make a reservation.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Charger Modal -->
<div class="modal fade" id="addChargerModal" tabindex="-1" aria-labelledby="addChargerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addChargerModalLabel">Add New Charger</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addChargerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="chargerName" class="form-label">Charger Name</label>
                            <input type="text" class="form-control" id="chargerName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="chargerType" class="form-label">Charger Type</label>
                            <select class="form-select" id="chargerType" name="charger_type" required>
                                <option value="">Select type</option>
                                <option value="Type 2">Type 2</option>
                                <option value="CCS">CCS</option>
                                <option value="CHAdeMO">CHAdeMO</option>
                                <option value="Tesla">Tesla</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address" name="address" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="latitude" class="form-label">Latitude</label>
                            <input type="number" step="any" class="form-control" id="latitude" name="latitude" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="longitude" class="form-label">Longitude</label>
                            <input type="number" step="any" class="form-control" id="longitude" name="longitude" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="powerOutput" class="form-label">Power Output (kW)</label>
                            <input type="number" step="0.1" class="form-control" id="powerOutput" name="power_output" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="pricePerHour" class="form-label">Price per Hour (DKK)</label>
                            <input type="number" step="0.01" class="form-control" id="pricePerHour" name="price_per_hour" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Availability</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="availableWeekdays" checked>
                            <label class="form-check-label" for="availableWeekdays">Weekdays</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="availableWeekends" checked>
                            <label class="form-check-label" for="availableWeekends">Weekends</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitCharger">Add Charger</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Sidebar link active state
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
            sidebarLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Smooth scroll for sidebar links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 20,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Simplified client-side form handling
    document.getElementById('submitCharger').addEventListener('click', function() {
        const form = document.getElementById('addChargerForm');
        
        // In a real app, you would validate and submit via AJAX
        // This is a simplified example that just simulates a successful submit
        alert('Charger added successfully!');
        
        // Close the modal
        var modal = bootstrap.Modal.getInstance(document.getElementById('addChargerModal'));
        modal.hide();
        
        // Refresh the page to show the new charger
        // In a real app, you would update the DOM instead
        setTimeout(() => {
            window.location.reload();
        }, 500);
    });
</script>
{% endblock %}